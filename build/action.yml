name: Build
description: Builds the Next.JS application

inputs:
  npm-token:
    description: NPM token
    default: ''
    required: false
  doppler-token:
    description: Doppler token
    default: ''
    required: false
  doppler-config:
    description: Doppler config (eg 'dev', 'staging')
    default: 'staging_ci'
    required: false
  sentry-auth-token:
    description: Sentry auth token (only needed if 'dry-run' is false)
    default: ''
    required: false
  dry-run:
    description: Whether to run the build in dry-run mode
    default: 'true'
    required: false

runs:
  using: composite
  steps:
    - uses: actions/checkout@v2

    - name: Cache Next.JS build cache
      id: cache-build
      uses: actions/cache@v3
      with:
        path: |
          ~/.npm
          ${{ github.workspace }}/.next
        # Generate a new cache whenever packages or source files change.
        key: ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
        # If source files changed but packages didn't, rebuild from a prior cache.
        restore-keys: |
          ${{ runner.os }}-nextjs-${{ hashFiles('**/yarn.lock') }}-

    - uses: ./.github/actions/install-dependencies
      with:
        npm-token: ${{ inputs.npm-token }}

    - name: Install Doppler CLI
      if: steps.cache-build.outputs.cache-hit != 'true'
      uses: dopplerhq/cli-action@v1
    - name: Setup Environment
      if: steps.cache-build.outputs.cache-hit != 'true'
      run: doppler setup --config ${{ inputs.doppler-config }} --project web
      shell: bash
      env:
        DOPPLER_TOKEN: ${{ inputs.doppler-token }}

    - name: Build
      run: doppler run -- yarn build
      shell: bash
      if: steps.cache-build.outputs.cache-hit != 'true'
      env:
        # Increase max heap size to make the build run as efficiently as possible
        NODE_OPTIONS: "--max_old_space_size=4096"
        # don't upload sourcemaps for staging builds during CI
        LDT_SENTRY_DRYRUN: '${{ inputs.dry-run }}'
        SENTRY_AUTH_TOKEN: ${{ inputs.sentry-auth-token }}
        DISABLE_ESLINT_TSC_CI: 'true'
        DOPPLER_TOKEN: ${{ inputs.doppler-token }}
